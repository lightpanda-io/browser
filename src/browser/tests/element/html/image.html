<!DOCTYPE html>
<script src="../../testing.js"></script>

<script id="Image">
{
    let i1 = new Image()
    testing.expectEqual(0, i1.width);
    testing.expectEqual(null, i1.getAttribute('width'));
    testing.expectEqual(0, i1.height);
    testing.expectEqual(null, i1.getAttribute('height'));

    let i2 = new Image(10)
    testing.expectEqual(10, i2.width);
    testing.expectEqual('10', i2.getAttribute('width'));
    testing.expectEqual(0, i2.height);
    testing.expectEqual(null, i2.getAttribute('height'));

    let i3 = new Image(10, 20)
    testing.expectEqual(10, i3.width);
    testing.expectEqual('10', i3.getAttribute('width'));
    testing.expectEqual(20, i3.height);
    testing.expectEqual('20', i3.getAttribute('height'));
}
</script>

<script id="src_alt">
{
    const img = document.createElement('img');

    testing.expectEqual('', img.src);
    testing.expectEqual('', img.alt);

    img.src = 'test.png';
    // src property returns resolved absolute URL
    testing.expectEqual(testing.BASE_URL + 'element/html/test.png', img.src);
    // getAttribute returns the raw attribute value
    testing.expectEqual('test.png', img.getAttribute('src'));

    img.src = '/absolute/path.png';
    testing.expectEqual(testing.ORIGIN + 'absolute/path.png', img.src);
    testing.expectEqual('/absolute/path.png', img.getAttribute('src'));

    img.src = 'https://example.com/image.png';
    testing.expectEqual('https://example.com/image.png', img.src);
    testing.expectEqual('https://example.com/image.png', img.getAttribute('src'));

    img.alt = 'Test image';
    testing.expectEqual('Test image', img.alt);
    testing.expectEqual('Test image', img.getAttribute('alt'));
}
</script>

<script id="width_height_setters">
{
    const img = document.createElement('img');

    img.width = 100;
    testing.expectEqual(100, img.width);
    testing.expectEqual('100', img.getAttribute('width'));

    img.height = 200;
    testing.expectEqual(200, img.height);
    testing.expectEqual('200', img.getAttribute('height'));

    img.setAttribute('width', '50');
    testing.expectEqual(50, img.width);

    img.setAttribute('height', 'invalid');
    testing.expectEqual(0, img.height);
}
</script>

<script id="crossOrigin">
{
    const img = document.createElement('img');

    testing.expectEqual(null, img.crossOrigin);

    img.crossOrigin = 'anonymous';
    testing.expectEqual('anonymous', img.crossOrigin);
    testing.expectEqual('anonymous', img.getAttribute('crossorigin'));

    img.crossOrigin = null;
    testing.expectEqual(null, img.crossOrigin);
    testing.expectEqual(null, img.getAttribute('crossorigin'));
}
</script>

<script id="loading">
{
    const img = document.createElement('img');

    testing.expectEqual('eager', img.loading);

    img.loading = 'lazy';
    testing.expectEqual('lazy', img.loading);
    testing.expectEqual('lazy', img.getAttribute('loading'));
}
</script>

<script id="complete">
{
    // Image with no src is complete per spec
    const img = document.createElement('img');
    testing.expectEqual(true, img.complete);

    // Image with src is also complete (headless browser, no actual fetch)
    img.src = 'test.png';
    testing.expectEqual(true, img.complete);

    // Image constructor also complete
    const img2 = new Image();
    testing.expectEqual(true, img2.complete);
}
</script>

<script id="load-trigger-event">
{
  const img = document.createElement("img");
  let count = 0;
  img.addEventListener("load", ({ bubbles, cancelBubble, cancelable, composed, isTrusted, target }) => {
    testing.expectEqual(true, count < 3);
    count++;

    testing.expectEqual(false, bubbles);
    testing.expectEqual(false, cancelBubble);
    testing.expectEqual(false, cancelable);
    testing.expectEqual(false, composed);
    testing.expectEqual(true, isTrusted);
    testing.expectEqual(img, target);
  });

  for (let i = 0; i < 3; i++) {
    img.src = "https://cdn.lightpanda.io/website/assets/images/docs/hn.png";
    testing.expectEqual("https://cdn.lightpanda.io/website/assets/images/docs/hn.png", img.src);
  }

  // Make sure count is incremented asynchronously.
  testing.expectEqual(0, count);
}
</script>

<img
  id="inline-img"
  src="https://cdn.lightpanda.io/website/assets/images/docs/hn.png"
  onload="(() => testing.expectEqual(true, true))()"
/>

<script id="inline-on-load">
{
  const img = document.getElementById("inline-img");
  testing.expectEqual(true, img.onload instanceof Function);
  // Also call inline to double check.
  img.onload();

  // Make sure ones attached with `addEventListener` also executed.
  testing.async(async () => {
    const result = await new Promise(resolve => {
      img.addEventListener("load", ({ bubbles, cancelBubble, cancelable, composed, isTrusted, target }) => {
        testing.expectEqual(false, bubbles);
        testing.expectEqual(false, cancelBubble);
        testing.expectEqual(false, cancelable);
        testing.expectEqual(false, composed);
        testing.expectEqual(true, isTrusted);
        testing.expectEqual(img, target);

        return resolve(true);
      });
    });

    testing.expectEqual(true, result);
  });
}
</script>

<script id=url_encode>
  {
    let img = document.createElement('img');
    img.src = 'over 9000!?hello=world !';
    testing.expectEqual('over 9000!?hello=world !', img.getAttribute('src'));
    testing.expectEqual(testing.BASE_URL + 'element/html/over%209000!?hello=world%20!', img.src);
  }
</script>
