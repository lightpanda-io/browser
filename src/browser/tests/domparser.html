<!DOCTYPE html>
<script src="testing.js"></script>
<body></body>

<script id=basic>
{
  const parser = new DOMParser();
  testing.expectEqual('object', typeof parser);
  testing.expectEqual('function', typeof parser.parseFromString);
}
</script>

<script id=parseSimpleHTML>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div>Hello World</div>', 'text/html');

  testing.expectEqual('object', typeof doc);
  testing.expectEqual('[object HTMLDocument]', doc.toString());

  const div = doc.querySelector('div');
  testing.expectEqual('DIV', div.tagName);
  testing.expectEqual('Hello World', div.textContent);
}
</script>

<script id=parseWithAttributes>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div id="test" class="foo">Content</div>', 'text/html');

  const div = doc.querySelector('div');
  testing.expectEqual('test', div.id);
  testing.expectEqual('foo', div.className);
  testing.expectEqual('Content', div.textContent);
}
</script>

<script id=parseMultipleElements>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div>First</div><span>Second</span>', 'text/html');

  const div = doc.querySelector('div');
  const span = doc.querySelector('span');

  testing.expectEqual('DIV', div.tagName);
  testing.expectEqual('First', div.textContent);
  testing.expectEqual('SPAN', span.tagName);
  testing.expectEqual('Second', span.textContent);
}
</script>

<script id=parseNestedElements>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div><p><span>Nested</span></p></div>', 'text/html');

  const div = doc.querySelector('div');
  const p = doc.querySelector('p');
  const span = doc.querySelector('span');

  testing.expectEqual('DIV', div.tagName);
  testing.expectEqual('P', p.tagName);
  testing.expectEqual('SPAN', span.tagName);
  testing.expectEqual('Nested', span.textContent);
  testing.expectEqual(p, div.firstChild);
  testing.expectEqual(span, p.firstChild);
}
</script>

<script id=parseEmptyString>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('', 'text/html');

  testing.expectEqual('object', typeof doc);
  testing.expectEqual('[object HTMLDocument]', doc.toString());
}
</script>

<script id=parsedDocumentIsIndependent>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div id="parsed">Parsed</div>', 'text/html');

  // The parsed document should be independent from the current document
  const currentDiv = document.querySelector('div');
  const parsedDiv = doc.querySelector('div');

  testing.expectEqual(null, currentDiv);
  testing.expectEqual('parsed', parsedDiv.id);
  testing.expectEqual('Parsed', parsedDiv.textContent);
}
</script>

<script id=malformedHTMLDoesNotThrow>
{
  const parser = new DOMParser();

  // HTML parsers should be forgiving and not throw on malformed HTML
  const doc1 = parser.parseFromString('<div><p>unclosed', 'text/html');
  testing.expectEqual('object', typeof doc1);

  const doc2 = parser.parseFromString('<<<invalid>>>', 'text/html');
  testing.expectEqual('object', typeof doc2);
}
</script>

<script id=unsupportedMimeType>
{
  const parser = new DOMParser();

  // Should throw an error for unsupported MIME types
  testing.withError((err) => {
    testing.expectEqual('NotSupported', err.message);
  }, () => {
    parser.parseFromString('<div>test</div>', 'application/xml');
  });
}
</script>

<script id=getElementById>
{
  const doc = new DOMParser().parseFromString('<div id="new-node">new-node</div>', 'text/html');
  testing.expectEqual('new-node', doc.getElementById('new-node').textContent);
}
</script>

<script id=getElementById_isolationBetweenDocuments>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div id="shared-id">From parsed doc</div>', 'text/html');

  // Create element with same ID in main document
  const mainEl = document.createElement('div');
  mainEl.id = 'shared-id';
  mainEl.textContent = 'From main doc';
  document.body.appendChild(mainEl);

  // Each document should find its own element
  const mainFound = document.getElementById('shared-id');
  testing.expectEqual('From main doc', mainFound.textContent);

  const parsedFound = doc.getElementById('shared-id');
  testing.expectEqual('From parsed doc', parsedFound.textContent);

  // Clean up
  mainEl.remove();
}
</script>

<script id=getElementById_afterSettingId>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div>No ID initially</div>', 'text/html');

  const div = doc.querySelector('div');

  // Should not find it yet
  testing.expectEqual(null, doc.getElementById('new-id'));

  // Set ID via JavaScript
  div.id = 'new-id';

  // Should now find it
  const found = doc.getElementById('new-id');
  testing.expectEqual(div, found);
}
</script>

<script id=getElementById_afterRemovingId>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div id="remove-me">Content</div>', 'text/html');

  // Should find it initially
  const div = doc.getElementById('remove-me');
  testing.expectEqual('Content', div.textContent);

  // Remove the ID
  div.removeAttribute('id');

  // Should not find it anymore
  testing.expectEqual(null, doc.getElementById('remove-me'));
}
</script>

<script id=getElementById_afterChangingId>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div id="old-id">Content</div>', 'text/html');

  const div = doc.querySelector('div');

  // Change the ID
  div.id = 'new-id';

  // Should not find old ID
  testing.expectEqual(null, doc.getElementById('old-id'));

  // Should find new ID
  const found = doc.getElementById('new-id');
  testing.expectEqual(div, found);
}
</script>

<script id=getElementById_detachedFromParsedDoc>
{
  const parser = new DOMParser();
  const doc = parser.parseFromString('<div id="will-detach">Content</div>', 'text/html');

  const div = doc.querySelector('div');

  // Should find it while connected
  testing.expectEqual(div, doc.getElementById('will-detach'));

  // Remove it from the document
  div.remove();

  // Should not find it after removal
  testing.expectEqual(null, doc.getElementById('will-detach'));
}
</script>

<script id=getElementById_multipleDocuments>
{
  const parser = new DOMParser();
  const doc1 = parser.parseFromString('<div id="doc1-el">Doc 1</div>', 'text/html');
  const doc2 = parser.parseFromString('<div id="doc2-el">Doc 2</div>', 'text/html');

  // Each document should only find its own element
  testing.expectEqual('Doc 1', doc1.getElementById('doc1-el').textContent);
  testing.expectEqual(null, doc1.getElementById('doc2-el'));

  testing.expectEqual('Doc 2', doc2.getElementById('doc2-el').textContent);
  testing.expectEqual(null, doc2.getElementById('doc1-el'));
}
</script>

<script id=documentElement>
  testing.expectEqual('', new DOMParser().parseFromString('', "text/html").documentElement.textContent);
  testing.expectEqual('spice', new DOMParser().parseFromString('spice', "text/html").documentElement.textContent);
  testing.expectEqual('<html><head></head><body>spice</body></html>', new DOMParser().parseFromString('spice', "text/html").documentElement.outerHTML);
  testing.expectEqual('<html><head></head><body></body></html>', new DOMParser().parseFromString('<html></html>', "text/html").documentElement.outerHTML);
</script>
