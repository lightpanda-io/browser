<!DOCTYPE html>
<script src="testing.js"></script>

<script id=getRandomValues>
  function isRandom(ta) {
    let uniq = new Set(Array.from(ta));
    testing.expectEqual(true, (uniq.size / ta.length) * 100 > 0.7)
  }
  {
    let tu8a = new Uint8Array(100)
    testing.expectEqual(tu8a, crypto.getRandomValues(tu8a))
    isRandom(tu8a)

    let ti8a = new Int8Array(100)
    testing.expectEqual(ti8a, crypto.getRandomValues(ti8a))
    isRandom(ti8a)
  }

  {
    let tu16a = new Uint16Array(100)
    testing.expectEqual(tu16a, crypto.getRandomValues(tu16a))
    isRandom(tu16a)

    let ti16a = new Int16Array(100)
    testing.expectEqual(ti16a, crypto.getRandomValues(ti16a))
    isRandom(ti16a)
  }

  {
    let tu32a = new Uint32Array(100)
    testing.expectEqual(tu32a, crypto.getRandomValues(tu32a))
    isRandom(tu32a)

    let ti32a = new Int32Array(100)
    testing.expectEqual(ti32a, crypto.getRandomValues(ti32a))
    isRandom(ti32a)
  }

  {
    let tu64a = new BigUint64Array(100)
    testing.expectEqual(tu64a, crypto.getRandomValues(tu64a))
    isRandom(tu64a)

    let ti64a = new BigInt64Array(100)
    testing.expectEqual(ti64a, crypto.getRandomValues(ti64a))
    isRandom(ti64a)
  }
</script>

<script id="randomUUID">
  const uuid = crypto.randomUUID();
  testing.expectEqual('string', typeof uuid);
  testing.expectEqual(36, uuid.length);
  const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
  testing.expectEqual(true, regex.test(uuid));
</script>

<script id=SubtleCrypto>
  testing.expectEqual(true, crypto.subtle instanceof SubtleCrypto);
</script>

<script id=sign-and-verify-hmac>
  testing.async(async () => {
    let key = await crypto.subtle.generateKey(
      {
        name: "HMAC",
        hash: { name: "SHA-512" },
      },
      true,
      ["sign", "verify"],
    );

    testing.expectEqual(true, key instanceof CryptoKey);

    const raw = await crypto.subtle.exportKey("raw", key);
    testing.expectEqual(128, raw.byteLength);

    const encoder = new TextEncoder();

    const signature = await crypto.subtle.sign(
      "HMAC",
      key,
      encoder.encode("Hello, world!")
    );

    testing.expectEqual(true, signature instanceof ArrayBuffer);

    const result = await window.crypto.subtle.verify(
      { name: "HMAC" },
      key,
      signature,
      encoder.encode("Hello, world!")
    );

    testing.expectEqual(true, result);
  });
</script>

<script id=derive-shared-key-x25519>
  testing.async(async () => {
    const { privateKey, publicKey } = await crypto.subtle.generateKey(
      { name: "X25519" },
      true,
      ["deriveBits"],
    );

    testing.expectEqual(true, privateKey instanceof CryptoKey);
    testing.expectEqual(true, publicKey instanceof CryptoKey);

    const sharedKey = await crypto.subtle.deriveBits(
      {
        name: "X25519",
        public: publicKey,
      },
      privateKey,
      128,
    );

    testing.expectEqual(16, sharedKey.byteLength);
  });
</script>

<script id="digest">
  testing.async(async () => {
    async function hash(algo, data) {
      const buffer = await window.crypto.subtle.digest(algo, new TextEncoder().encode(data));
      return [...new Uint8Array(buffer)].map(x => x.toString(16).padStart(2, '0')).join('');
    }
    testing.expectEqual("a6a1e3375239f215f09a156df29c17c7d1ac6722", await hash('sha-1', 'over 9000'));
    testing.expectEqual("1bc375bb92459685194dda18a4b835f4e2972ec1bde6d9ab3db53fcc584a6580", await hash('sha-256', 'over 9000'));
    testing.expectEqual("a4260d64c2eea9fd30c1f895c5e48a26d817e19d3a700b61b3ce665864ff4b8e012bd357d345aa614c5f642dab865ea1", await hash('sha-384', 'over 9000'));
    testing.expectEqual("6cad17e6f3f76680d6dd18ed043b75b4f6e1aa1d08b917294942e882fb6466c3510948c34af8b903ed0725b582b3b39c0e485ae2c1b7dfdb192ee38b79c782b6", await hash('sha-512', 'over 9000'));
  });
</script>
