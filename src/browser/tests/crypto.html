<!DOCTYPE html>
<script src="testing.js"></script>

<script id=getRandomValues>
  function isRandom(ta) {
    let uniq = new Set(Array.from(ta));
    testing.expectEqual(true, (uniq.size / ta.length) * 100 > 0.7)
  }
  {
    let tu8a = new Uint8Array(100)
    testing.expectEqual(tu8a, crypto.getRandomValues(tu8a))
    isRandom(tu8a)

    let ti8a = new Int8Array(100)
    testing.expectEqual(ti8a, crypto.getRandomValues(ti8a))
    isRandom(ti8a)
  }

  // {
  //   let tu16a = new Uint16Array(100)
  //   testing.expectEqual(tu16a, crypto.getRandomValues(tu16a))
  //   isRandom(tu16a)

  //   let ti16a = new Int16Array(100)
  //   testing.expectEqual(ti16a, crypto.getRandomValues(ti16a))
  //   isRandom(ti16a)
  // }

  // {
  //   let tu32a = new Uint32Array(100)
  //   testing.expectEqual(tu32a, crypto.getRandomValues(tu32a))
  //   isRandom(tu32a)

  //   let ti32a = new Int32Array(100)
  //   testing.expectEqual(ti32a, crypto.getRandomValues(ti32a))
  //   isRandom(ti32a)
  // }

  // {
  //   let tu64a = new BigUint64Array(100)
  //   testing.expectEqual(tu64a, crypto.getRandomValues(tu64a))
  //   isRandom(tu64a)

  //   let ti64a = new BigInt64Array(100)
  //   testing.expectEqual(ti64a, crypto.getRandomValues(ti64a))
  //   isRandom(ti64a)
  // }
</script>

<!-- <script id="randomUUID">
  const uuid = crypto.randomUUID();
  testing.expectEqual('string', typeof uuid);
  testing.expectEqual(36, uuid.length);
  const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
  testing.expectEqual(true, regex.test(uuid));
</script> -->

<script id=SubtleCrypto>
  testing.expectEqual(true, crypto.subtle instanceof SubtleCrypto);
</script>

<script id=sign-and-verify-hmac>
  testing.async(async () => {
    let key = await crypto.subtle.generateKey(
      {
        name: "HMAC",
        hash: { name: "SHA-512" },
      },
      true,
      ["sign", "verify"],
    );

    testing.expectEqual(true, key instanceof CryptoKey);

    const raw = await crypto.subtle.exportKey("raw", key);
    testing.expectEqual(128, raw.byteLength);

    const encoder = new TextEncoder();

    const signature = await crypto.subtle.sign(
      "HMAC",
      key,
      encoder.encode("Hello, world!")
    );

    testing.expectEqual(true, signature instanceof ArrayBuffer);

    const result = await window.crypto.subtle.verify(
      { name: "HMAC" },
      key,
      signature,
      encoder.encode("Hello, world!")
    );

    testing.expectEqual(true, result);
  });
</script>

<script id=derive-shared-key-x25519>
  testing.async(async () => {
    const { privateKey, publicKey } = await crypto.subtle.generateKey(
      { name: "X25519" },
      true,
      ["deriveBits"],
    );

    testing.expectEqual(true, privateKey instanceof CryptoKey);
    testing.expectEqual(true, publicKey instanceof CryptoKey);

    const sharedKey = await crypto.subtle.deriveBits(
      {
        name: "X25519",
        public: publicKey,
      },
      privateKey,
      128,
    );

    testing.expectEqual(16, sharedKey.byteLength);
  });
</script>
