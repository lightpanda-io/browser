<!DOCTYPE html>
<head id="the_head">
  <title>Test Document Title</title>
  <script src="../testing.js"></script>
</head>

<body id=the_body>
</body>

<script id=document>
  testing.expectEqual(10, document.childNodes[0].nodeType);
  testing.expectEqual(null, document.parentNode);
  testing.expectEqual(undefined, document.getCurrentScript);
  testing.expectEqual("http://127.0.0.1:9582/src/browser/tests/document/document.html", document.URL);
  testing.expectEqual(window, document.defaultView);
</script>

<script id=headAndbody>
  testing.expectEqual($('#the_head'), document.head);
  testing.expectEqual($('#the_body'), document.body);
</script>

<script id=documentElement>
  testing.expectEqual($('#the_body').parentNode, document.documentElement);
</script>

<script id=title>
  testing.expectEqual('Test Document Title', document.title);
  document.title = 'New Title';
  testing.expectEqual('New Title', document.title);
  document.title = '';
  testing.expectEqual('', document.title);
</script>

<script id=createTextNode>
  const textNode = document.createTextNode('Hello World');
  testing.expectEqual(3, textNode.nodeType);
  testing.expectEqual('Hello World', textNode.nodeValue);
  testing.expectEqual('Hello World', textNode.textContent);

  const emptyText = document.createTextNode('');
  testing.expectEqual('', emptyText.nodeValue);
</script>

<script id=document_metadata>
  // Test document metadata properties on HTML document
  testing.expectEqual('text/html', document.contentType);
  testing.expectEqual('UTF-8', document.characterSet);
  testing.expectEqual('UTF-8', document.charset);
  testing.expectEqual('UTF-8', document.inputEncoding);
  testing.expectEqual('CSS1Compat', document.compatMode);
  testing.expectEqual(document.URL, document.documentURI);
  testing.expectEqual('', document.referrer);
  testing.expectEqual('127.0.0.1', document.domain);
</script>

<script id=programmatic_document_metadata>
  // Test document metadata properties on programmatically created document
  const doc = new Document();
  testing.expectEqual('application/xml', doc.contentType);
  testing.expectEqual('UTF-8', doc.characterSet);
  testing.expectEqual('UTF-8', doc.charset);
  testing.expectEqual('UTF-8', doc.inputEncoding);
  testing.expectEqual('CSS1Compat', doc.compatMode);
  testing.expectEqual('', doc.referrer);
  // Programmatic document should have empty domain (no URL/origin)
  testing.expectEqual('127.0.0.1', doc.domain);
</script>

<!-- Test anchors and links -->
<a id="link1" href="/page1">Link 1</a>
<a id="link2" href="/page2">Link 2</a>
<a id="anchor1" name="section1">Anchor 1</a>
<a id="anchor2" name="section2">Anchor 2</a>
<a id="both" href="/page3" name="section3">Both href and name</a>
<a id="no_attrs">No attributes</a>

<script id=document_links>
  {
    // document.links should only include <a> elements with href attribute
    const links = document.links;
    testing.expectEqual('HTMLCollection', links.constructor.name);
    testing.expectEqual(3, links.length);

    // Should include link1, link2, and both
    testing.expectEqual($('#link1'), links[0]);
    testing.expectEqual($('#link2'), links[1]);
    testing.expectEqual($('#both'), links[2]);

    // Indexed access
    testing.expectEqual($('#link1'), links.item(0));
    testing.expectEqual($('#link2'), links.item(1));
    testing.expectEqual($('#both'), links.item(2));
    testing.expectEqual(null, links.item(3));
  }
</script>

<script id=document_anchors>
  {
    // document.anchors should only include <a> elements with name attribute
    const anchors = document.anchors;
    testing.expectEqual('HTMLCollection', anchors.constructor.name);
    testing.expectEqual(3, anchors.length);

    // Should include anchor1, anchor2, and both
    testing.expectEqual($('#anchor1'), anchors[0]);
    testing.expectEqual($('#anchor2'), anchors[1]);
    testing.expectEqual($('#both'), anchors[2]);

    // Indexed access
    testing.expectEqual($('#anchor1'), anchors.item(0));
    testing.expectEqual($('#anchor2'), anchors.item(1));
    testing.expectEqual($('#both'), anchors.item(2));
    testing.expectEqual(null, anchors.item(3));
  }
</script>

<script id=links_live_collection>
  {
    // Test that document.links is a live collection
    const links = document.links;
    const initialLength = links.length;

    // Add a new link
    const newLink = document.createElement('a');
    newLink.href = '/new-page';
    newLink.textContent = 'New Link';
    document.body.appendChild(newLink);

    testing.expectEqual(initialLength + 1, links.length);
    testing.expectEqual(newLink, links[links.length - 1]);

    // Remove href attribute - should no longer be in links
    newLink.removeAttribute('href');
    testing.expectEqual(initialLength, links.length);

    // Add it back
    newLink.href = '/another-page';
    testing.expectEqual(initialLength + 1, links.length);

    // Remove the element
    newLink.remove();
    testing.expectEqual(initialLength, links.length);
  }
</script>

<script id=anchors_live_collection>
  // Test that document.anchors is a live collection
  const anchors = document.anchors;
  const initialLength = anchors.length;

  // Add a new anchor
  const newAnchor = document.createElement('a');
  newAnchor.name = 'new-section';
  newAnchor.textContent = 'New Anchor';
  document.body.appendChild(newAnchor);

  testing.expectEqual(initialLength + 1, anchors.length);
  testing.expectEqual(newAnchor, anchors[anchors.length - 1]);

  // Remove name attribute - should no longer be in anchors
  newAnchor.removeAttribute('name');
  testing.expectEqual(initialLength, anchors.length);

  // Add it back
  newAnchor.name = 'another-section';
  testing.expectEqual(initialLength + 1, anchors.length);

  // Remove the element
  newAnchor.remove();
  testing.expectEqual(initialLength, anchors.length);
</script>

<script id=cookie>
  testing.expectEqual('', document.cookie);
  document.cookie = 'name=Oeschger;';
  document.cookie = 'favorite_food=tripe;';

  testing.expectEqual('name=Oeschger; favorite_food=tripe', document.cookie);
  // "" should be returned, but the framework overrules it atm
  document.cookie = 'IgnoreMy=Ghost; HttpOnly';
  testing.expectEqual('name=Oeschger; favorite_food=tripe', document.cookie);
</script>

<script id=createAttribute>
  {
    var attr = document.createAttribute('hello');
    testing.expectEqual('hello', attr.name);
    testing.expectEqual('', attr.value);

    testing.withError((err) => {
      testing.expectEqual(5, err.code);
      testing.expectEqual("InvalidCharacterError", err.name);
    }, () => document.createAttribute(''));

    testing.withError((err) => {
      testing.expectEqual(5, err.code);
      testing.expectEqual("InvalidCharacterError", err.name);
    }, () => document.createAttribute('.over'));
  }
</script>

<script id=append>
{
  const doc = new Document();
  const html = doc.createElement('html');
  const body = doc.createElement('body');
  const div1 = doc.createElement('div');
  const div2 = doc.createElement('div');

  doc.append(html);
  testing.expectEqual(1, doc.childNodes.length);
  testing.expectEqual(html, doc.childNodes[0]);

  html.append(body);
  testing.expectEqual(1, html.childNodes.length);
  testing.expectEqual(body, html.childNodes[0]);

  body.append(div1, div2);
  testing.expectEqual(2, body.childNodes.length);
  testing.expectEqual(div1, body.childNodes[0]);
  testing.expectEqual(div2, body.childNodes[1]);

  body.append('text node');
  testing.expectEqual(3, body.childNodes.length);
  testing.expectEqual(3, body.childNodes[2].nodeType);
  testing.expectEqual('text node', body.childNodes[2].textContent);
}
</script>

<script id=prepend>
{
  const doc = new Document();
  const html = doc.createElement('html');
  const body = doc.createElement('body');
  const div1 = doc.createElement('div');
  const div2 = doc.createElement('div');
  const div3 = doc.createElement('div');

  doc.prepend(html);
  testing.expectEqual(1, doc.childNodes.length);
  testing.expectEqual(html, doc.childNodes[0]);

  html.prepend(body);
  testing.expectEqual(1, html.childNodes.length);
  testing.expectEqual(body, html.childNodes[0]);

  body.append(div1);
  body.prepend(div2, div3);
  testing.expectEqual(3, body.childNodes.length);
  testing.expectEqual(div2, body.childNodes[0]);
  testing.expectEqual(div3, body.childNodes[1]);
  testing.expectEqual(div1, body.childNodes[2]);

  body.prepend('text node');
  testing.expectEqual(4, body.childNodes.length);
  testing.expectEqual(3, body.childNodes[0].nodeType);
  testing.expectEqual('text node', body.childNodes[0].textContent);
}
</script>

<script id=children>
  testing.expectEqual(1, document.children.length);
  testing.expectEqual('HTML', document.children.item(0).nodeName)
  testing.expectEqual('HTML', document.firstElementChild.nodeName);
  testing.expectEqual('HTML', document.lastElementChild.nodeName);
  testing.expectEqual(1, document.childElementCount);

  let nd = new Document();
  testing.expectEqual(0, nd.children.length);
  testing.expectEqual(null, nd.children.item(0));
  testing.expectEqual(null, nd.firstElementChild);
  testing.expectEqual(null, nd.lastElementChild);
  testing.expectEqual(0, nd.childElementCount);
</script>

<script id=adoptedStyleSheets>
  {
    const acss = document.adoptedStyleSheets;
    testing.expectEqual(0, acss.length);
    acss.push(new CSSStyleSheet());
    testing.expectEqual(1, acss.length);
  }
</script>
